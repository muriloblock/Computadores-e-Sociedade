<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portf√≥lio - ModelaInvest</title>
    <link rel="icon" type="image/png" href="../../assets/images/investsmart-logo.png">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/simulator.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="../css/logo.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo-header">
                <img src="../../assets/images/investsmart-logo.png" alt="ModelaInvest Logo">
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Simulador</a></li>
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="learn.html">Aprender</a></li>
                    <li><a href="portfolio.html">Portf√≥lio</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section class="hero">
            <div class="container">
                <h2>Seu Portf√≥lio de Investimentos</h2>
                <p>Construa e gerencie um portf√≥lio diversificado</p>
            </div>
        </section>

        <section class="simulator-section">
            <div class="container">
                <h2>Construtor de Portf√≥lio</h2>
                
                <div class="portfolio-builder">
                    <div class="builder-left builder-form">
                        <h3>Criar Novo Portf√≥lio</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="portfolio-valor">Valor Total (R$):</label>
                                <input type="number" id="portfolio-valor" value="50000" min="1000" step="1000">
                            </div>
                            <div class="form-group">
                                <label for="portfolio-perfil">Perfil de Risco:</label>
                                <select id="portfolio-perfil">
                                    <option value="conservador">Conservador</option>
                                    <option value="moderado">Moderado</option>
                                    <option value="arrojado">Arrojado</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row form-mode-row" style="margin-top:10px; gap:15px; align-items:center;">
                            <div style="display:flex; gap:10px;">
                                <label style="display:flex; align-items:center; gap:5px; font-size:0.85em;">
                                    <input type="radio" name="modo-alocacao" value="perfil" checked> Usar perfil
                                </label>
                                <label style="display:flex; align-items:center; gap:5px; font-size:0.85em;">
                                    <input type="radio" name="modo-alocacao" value="custom"> Personalizado
                                </label>
                            </div>
                        </div>
                        <div id="custom-allocation" class="custom-allocation" style="display:none;">
                            <h4 class="section-subtitle">Aloca√ß√£o Personalizada (%)</h4>
                            <div id="allocation-rows" class="allocation-rows"></div>
                            <div class="allocation-actions">
                                <button type="button" id="btn-add-ativo" class="btn-secondary btn-small">+ Ativo</button>
                                <span id="percent-total" class="percent-total">Total: 0%</span>
                                <span id="percent-warning" class="percent-warning" style="display:none;">A soma deve ser 100%</span>
                            </div>
                        </div>
                        <div class="portfolio-allocation">
                            <h3>Aloca√ß√£o</h3>
                            <div id="alocacao-sugerida" class="allocation-display">
                                <!-- Aloca√ß√£o ser√° exibida aqui -->
                            </div>
                        </div>
                    </div>
                    <div class="builder-right">
                        <div class="allocation-chart">
                            <canvas id="grafico-alocacao"></canvas>
                        </div>
                    </div>
                </div>

                <div class="portfolio-results">
                    <div class="portfolio-summary">
                        <h3>Resumo do Portf√≥lio</h3>
                        <div class="summary-cards">
                            <div class="summary-card">
                                <h4>Valor Investido</h4>
                                <p id="portfolio-investido">R$ 0,00</p>
                            </div>
                            <div class="summary-card">
                                <h4 id="label-projetado">Valor Projetado</h4>
                                <p id="portfolio-projetado">R$ 0,00</p>
                            </div>
                            <div class="summary-card">
                                <h4>Rendimento Esperado</h4>
                                <p id="portfolio-rendimento">R$ 0,00</p>
                            </div>
                            <div class="summary-card">
                                <h4>Rentabilidade M√©dia</h4>
                                <p id="portfolio-rentabilidade">0%</p>
                            </div>
                        </div>
                    </div>

                    <div class="portfolio-charts">
                        <div class="chart-container">
                            <div class="chart-top-controls">
                                <label>Horizonte
                                    <select id="chart-horizonte">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5" selected>5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="12">12</option>
                                        <option value="15">15</option>
                                        <option value="20">20</option>
                                    </select>
                                </label>
                            </div>
                            <canvas id="grafico-evolucao-portfolio"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="educational-section">
            <div class="container">
                <h2>Estrat√©gias de Portf√≥lio</h2>
                
                <div class="strategy-cards">
                    <div class="strategy-card">
                        <h3>üõ°Ô∏è Portf√≥lio Conservador</h3>
                        <div class="strategy-allocation">
                            <div class="allocation-item">
                                <span class="allocation-label">Renda Fixa</span>
                                <span class="allocation-bar">
                                    <span class="allocation-fill" style="width: 80%"></span>
                                </span>
                                <span class="allocation-percent">80%</span>
                            </div>
                            <div class="allocation-item">
                                <span class="allocation-label">Renda Vari√°vel</span>
                                <span class="allocation-bar">
                                    <span class="allocation-fill" style="width: 20%"></span>
                                </span>
                                <span class="allocation-percent">20%</span>
                            </div>
                        </div>
                        <p><strong>Objetivo:</strong> Preserva√ß√£o de capital com baixo risco</p>
                        <p><strong>Rentabilidade esperada:</strong> 8-12% ao ano</p>
                    </div>

                    <div class="strategy-card">
                        <h3>‚öñÔ∏è Portf√≥lio Moderado</h3>
                        <div class="strategy-allocation">
                            <div class="allocation-item">
                                <span class="allocation-label">Renda Fixa</span>
                                <span class="allocation-bar">
                                    <span class="allocation-fill" style="width: 50%"></span>
                                </span>
                                <span class="allocation-percent">50%</span>
                            </div>
                            <div class="allocation-item">
                                <span class="allocation-label">Renda Vari√°vel</span>
                                <span class="allocation-bar">
                                    <span class="allocation-fill" style="width: 50%"></span>
                                </span>
                                <span class="allocation-percent">50%</span>
                            </div>
                        </div>
                        <p><strong>Objetivo:</strong> Equilibrio entre seguran√ßa e crescimento</p>
                        <p><strong>Rentabilidade esperada:</strong> 12-16% ao ano</p>
                    </div>

                    <div class="strategy-card">
                        <h3>üöÄ Portf√≥lio Arrojado</h3>
                        <div class="strategy-allocation">
                            <div class="allocation-item">
                                <span class="allocation-label">Renda Fixa</span>
                                <span class="allocation-bar">
                                    <span class="allocation-fill" style="width: 20%"></span>
                                </span>
                                <span class="allocation-percent">20%</span>
                            </div>
                            <div class="allocation-item">
                                <span class="allocation-label">Renda Vari√°vel</span>
                                <span class="allocation-bar">
                                    <span class="allocation-fill" style="width: 80%"></span>
                                </span>
                                <span class="allocation-percent">80%</span>
                            </div>
                        </div>
                        <p><strong>Objetivo:</strong> M√°ximo crescimento com maior risco</p>
                        <p><strong>Rentabilidade esperada:</strong> 16-20% ao ano</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="simulator-section">
            <div class="container">
                <h2>Rebalanceamento de Portf√≥lio</h2>
                
                <div class="rebalancing-info">
                    <div class="info-card">
                        <h3>Por que Rebalancear?</h3>
                        <ul>
                            <li>Manter a aloca√ß√£o desejada</li>
                            <li>Realizar lucros automaticamente</li>
                            <li>Reduzir volatilidade</li>
                            <li>Manter disciplina de investimento</li>
                        </ul>
                    </div>
                    
                    <div class="info-card">
                        <h3>Quando Rebalancear?</h3>
                        <ul>
                            <li>Trimestralmente ou semestralmente</li>
                            <li>When uma classe de ativo desvia >5%</li>
                            <li>Em momentos de alta volatilidade</li>
                            <li>Mudan√ßas no perfil de risco</li>
                        </ul>
                    </div>
                    
                    <div class="info-card">
                        <h3>Como Rebalancear?</h3>
                        <ul>
                            <li>Venda ativos com peso acima do alvo</li>
                            <li>Compre ativos com peso abaixo do alvo</li>
                            <li>Use novos aportes para rebalancear</li>
                            <li>Considere custos de transa√ß√£o</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Simulador de Investimentos. Desenvolvido para fins educativos.</p>
        </div>
    </footer>

    <!-- Carregar API antes dos outros scripts -->
    <script src="../js/api.js"></script>
    <script src="../js/simulator.js"></script>
    <script src="../js/charts.js"></script>
    <script>
        // Isolar l√≥gica da p√°gina para evitar re-declara√ß√£o (erro de vari√°vel j√° declarada)
        (function(){
        // Inst√¢ncias dos gr√°ficos (escopo local)
        let graficoAlocacao = null;
        let graficoEvolucao = null;
        
        const alocacoesPorPerfil = {
            'conservador': {
                'cdb': 0.4,
                'tesouro-selic': 0.25,
                'lci': 0.15,
                'acoes': 0.15,
                'fiis': 0.05
            },
            'moderado': {
                'cdb': 0.25,
                'tesouro-ipca': 0.25,
                'acoes': 0.35,
                'fiis': 0.15
            },
            'arrojado': {
                'tesouro-selic': 0.1,
                'tesouro-ipca': 0.1,
                'acoes': 0.60,
                'fiis': 0.20
            }
        };
        
        const nomesInvestimentos = {
            'poupanca': 'Poupan√ßa',
            'cdb': 'CDB',
            'lci': 'LCI/LCA',
            'tesouro-selic': 'Tesouro Selic',
            'tesouro-ipca': 'Tesouro IPCA+',
            'acoes': 'A√ß√µes',
            'fiis': 'FIIs',
            'nao-alocado': 'N√£o Alocado'
        };
        
        function criarPortfolio() {
            const valor = parseFloat(document.getElementById('portfolio-valor').value);
            const perfil = document.getElementById('portfolio-perfil').value;
            const horizonte = parseInt(document.getElementById('chart-horizonte').value) || 5;
            const modo = document.querySelector('input[name="modo-alocacao"]:checked').value;

            // Obter aloca√ß√£o conforme modo
            let alocacao;
            if (modo === 'custom') {
                alocacao = obterAlocacaoPersonalizada();
            } else {
                alocacao = alocacoesPorPerfil[perfil];
            }

            const alocacaoDisplay = document.getElementById('alocacao-sugerida');
            
            let html = '<div class="allocation-list">';
            let valorTotal = 0;
            let rendimentoTotal = 0;
            let taxaMediaPonderada = 0;
            
            Object.entries(alocacao).forEach(([tipo, percentual]) => {
                const valorAlocado = valor * percentual;
                
                // N√£o simular investimento para categoria "N√£o Alocado"
                if (tipo === 'nao-alocado') {
                    html += `
                        <div class="allocation-row" style="opacity: 0.6;">
                            <span class="investment-name">${nomesInvestimentos[tipo]}</span>
                            <span class="investment-percent">${(percentual * 100).toFixed(1)}%</span>
                            <span class="investment-value">${formatarMoeda(valorAlocado)}</span>
                            <span class="investment-future">${formatarMoeda(valorAlocado)}</span>
                        </div>
                    `;
                    return;
                }
                
                const resultado = simularInvestimento(tipo, valorAlocado, 0, horizonte);
                const rendimento = resultado.valorFinal - resultado.valorInvestido;
                
                valorTotal += resultado.valorFinal;
                rendimentoTotal += rendimento;
                taxaMediaPonderada += taxasInvestimento[tipo] * percentual;
                
                html += `
                    <div class="allocation-row">
                        <span class="investment-name">${nomesInvestimentos[tipo]}</span>
                        <span class="investment-percent">${(percentual * 100).toFixed(1)}%</span>
                        <span class="investment-value">${formatarMoeda(valorAlocado)}</span>
                        <span class="investment-future">${formatarMoeda(resultado.valorFinal)}</span>
                    </div>
                `;
            });
            
            html += '</div>';
            alocacaoDisplay.innerHTML = html;
            
            // Atualizar resumo
            document.getElementById('portfolio-investido').textContent = formatarMoeda(valor);
            document.getElementById('portfolio-projetado').textContent = formatarMoeda(valorTotal);
            document.getElementById('portfolio-rendimento').textContent = formatarMoeda(rendimentoTotal);
            document.getElementById('portfolio-rentabilidade').textContent = 
                ((taxaMediaPonderada * 12) * 100).toFixed(2) + '% a.a.';
            document.getElementById('label-projetado').textContent = `Valor Projetado (${horizonte} anos)`;
            
            // Criar gr√°ficos
            criarGraficoAlocacao(alocacao, valor);
            criarGraficoEvolucaoPortfolio(alocacao, valor, horizonte);
        }
        
        function criarGraficoAlocacao(alocacao, valor) {
            const ctx = document.getElementById('grafico-alocacao').getContext('2d');
            
            const labels = Object.keys(alocacao).map(tipo => nomesInvestimentos[tipo]);
            const data = Object.values(alocacao).map(p => p * valor);
            
            // Se o gr√°fico j√° existe, atualizar dados com anima√ß√£o
            if (graficoAlocacao) {
                graficoAlocacao.data.labels = labels;
                graficoAlocacao.data.datasets[0].data = data;
                graficoAlocacao.update('active'); // Anima√ß√£o suave
                return;
            }
            
            // Criar novo gr√°fico apenas na primeira vez
            graficoAlocacao = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(alocacao).map(tipo => nomesInvestimentos[tipo]),
                    datasets: [{
                        data: Object.values(alocacao).map(p => p * valor),
                        backgroundColor: Object.keys(alocacao).map(tipo => {
                            if (tipo === 'nao-alocado') return '#E2E8F0'; // Cinza claro
                            const cores = {
                                'poupanca': '#FF6384',
                                'cdb': '#36A2EB',
                                'lci': '#FFCE56',
                                'tesouro-selic': '#4BC0C0',
                                'tesouro-ipca': '#9966FF',
                                'acoes': '#FF9F40',
                                'fiis': '#4BC0C0'
                            };
                            return cores[tipo] || '#999';
                        })
                    }]
                },
                options: {
                    responsive: true,
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Aloca√ß√£o do Portf√≥lio'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = ((context.parsed / valor) * 100).toFixed(1);
                                    return `${context.label}: ${formatarMoeda(context.parsed)} (${percentage}%)`;
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    transitions: {
                        active: {
                            animation: {
                                duration: 400
                            }
                        }
                    }
                }
            });
        }
        
        function criarGraficoEvolucaoPortfolio(alocacao, valor, horizonteAnos = 10) {
            const ctx = document.getElementById('grafico-evolucao-portfolio').getContext('2d');
            
            const totalMeses = horizonteAnos * 12;
            const meses = Array.from({length: totalMeses + 1}, (_, i) => i);
            const evolucaoTotal = meses.map(mes => {
                let valorMes = 0;
                Object.entries(alocacao).forEach(([tipo, percentual]) => {
                    const valorInicial = valor * percentual;
                    const valorMensal = valorInicial * Math.pow(1 + taxasInvestimento[tipo], mes);
                    valorMes += valorMensal;
                });
                return valorMes;
            });
            
            // Se o gr√°fico j√° existe, atualizar dados com anima√ß√£o
            if (graficoEvolucao) {
                graficoEvolucao.data.labels = meses.map(m => `${Math.floor(m/12)}a ${m%12}m`);
                graficoEvolucao.data.datasets[0].data = evolucaoTotal;
                graficoEvolucao.options.plugins.title.text = `Evolu√ß√£o do Portf√≥lio (${horizonteAnos} anos)`;
                graficoEvolucao.update('active'); // Anima√ß√£o suave
                return;
            }
            
            // Criar novo gr√°fico apenas na primeira vez
            graficoEvolucao = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: meses.map(m => `${Math.floor(m/12)}a ${m%12}m`),
                    datasets: [{
                        label: 'Valor do Portf√≥lio',
                        data: evolucaoTotal,
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Evolu√ß√£o do Portf√≥lio (${horizonteAnos} anos)`
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatarMoeda(value);
                                }
                            }
                        }
                    },
                    transitions: {
                        active: {
                            animation: {
                                duration: 400
                            }
                        }
                    }
                }
            });
        }

        // ================= Aloca√ß√£o Personalizada =================
        const investimentosDisponiveis = Object.keys(nomesInvestimentos).filter(k => k !== 'poupanca');
        function adicionarLinhaAlocacao(tipoDefault = 'cdb', percentDefault = 0) {
            const container = document.getElementById('allocation-rows');
            const row = document.createElement('div');
            row.className = 'allocation-custom-row';
            row.style.cssText = 'display:flex; gap:8px; align-items:center;';
            row.innerHTML = `
                <select class="select-ativo" style="flex:1; padding:6px;">
                    ${investimentosDisponiveis.map(t => `<option value="${t}" ${t===tipoDefault?'selected':''}>${nomesInvestimentos[t]}</option>`).join('')}
                </select>
                <input type="number" min="0" max="100" step="0.5" value="${percentDefault}" class="percent-ativo" style="width:90px; padding:6px;" placeholder="%">
                <button type="button" class="btn-remove" style="padding:4px 8px;">‚úñ</button>
            `;
            container.appendChild(row);
            row.querySelector('.percent-ativo').addEventListener('input', atualizarPercentuaisTotais);
            row.querySelector('.select-ativo').addEventListener('change', atualizarPercentuaisTotais);
            row.querySelector('.btn-remove').addEventListener('click', () => { row.remove(); atualizarPercentuaisTotais(); });
            atualizarPercentuaisTotais();
        }

        function atualizarPercentuaisTotais() {
            const percInputs = Array.from(document.querySelectorAll('#allocation-rows .percent-ativo'));
            const total = percInputs.reduce((s, el) => s + (parseFloat(el.value)||0), 0);
            const totalSpan = document.getElementById('percent-total');
            const warn = document.getElementById('percent-warning');
            totalSpan.textContent = `Total: ${total.toFixed(1)}%`;
            if (Math.abs(total - 100) < 0.001) { warn.style.display='none'; } else { warn.style.display='inline'; }
            // Atualiza portf√≥lio em tempo real
            criarPortfolio();
        }

        function obterAlocacaoPersonalizada() {
            const rows = Array.from(document.querySelectorAll('#allocation-rows .allocation-custom-row'));
            const aloc = {};
            let soma = 0;
            rows.forEach(r => {
                const tipo = r.querySelector('.select-ativo').value;
                const percent = parseFloat(r.querySelector('.percent-ativo').value)||0;
                if (percent > 0) {
                    aloc[tipo] = percent/100;
                    soma += percent;
                }
            });
            
            // Se n√£o somar 100%, adicionar categoria "N√£o Alocado"
            if (soma < 100 && soma > 0) {
                aloc['nao-alocado'] = (100 - soma) / 100;
            }
            
            return aloc;
        }

        function prepararAlocacaoInicialCustom() {
            // Limpar e adicionar 3 linhas padr√£o
            document.getElementById('allocation-rows').innerHTML='';
            adicionarLinhaAlocacao('cdb', 40);
            adicionarLinhaAlocacao('acoes', 40);
            adicionarLinhaAlocacao('fiis', 20);
        }
        
        // Expor fun√ß√µes necess√°rias ao console (debug opcional)
        window.criarPortfolio = criarPortfolio;

        // Inicializa√ß√£o ap√≥s DOM pronto
        document.addEventListener('DOMContentLoaded', async () => {
            // Carregar taxas (se fun√ß√£o existir)
            if (typeof atualizarTaxasReais === 'function') {
                try { await atualizarTaxasReais(); } catch(e) { console.warn('Falha ao atualizar taxas', e); }
            }
            // Criar primeiro portf√≥lio
            criarPortfolio();
            // Toggle modo aloca√ß√£o
            document.querySelectorAll('input[name="modo-alocacao"]').forEach(r => {
                r.addEventListener('change', () => {
                    const customDiv = document.getElementById('custom-allocation');
                    if (r.value === 'custom' && r.checked) {
                        customDiv.style.display='block';
                        prepararAlocacaoInicialCustom();
                    } else if (r.value === 'perfil' && r.checked) {
                        customDiv.style.display='none';
                    }
                    criarPortfolio();
                });
            });
            // Bot√£o adicionar ativo
            const btnAdd = document.getElementById('btn-add-ativo');
            if (btnAdd) {
                btnAdd.addEventListener('click', () => adicionarLinhaAlocacao());
            }
            // Recalcular ao mudar perfil ou horizonte
            document.getElementById('portfolio-perfil').addEventListener('change', criarPortfolio);
            document.getElementById('portfolio-valor').addEventListener('input', criarPortfolio);
            document.getElementById('chart-horizonte').addEventListener('change', criarPortfolio);
        });
        })();
    </script>
</body>
</html>